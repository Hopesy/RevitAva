# Avalonia XAML 热重载使用指南

## 概述

本项目已配置 **HotAvalonia 3.0.2**，支持在 Debug 模式下进行 XAML 热重载，无需重启 Revit 即可实时查看 UI 修改效果。

## 配置说明

### 已安装的包

```xml
<!-- RevitAva.csproj -->
<PackageReference Include="HotAvalonia" Version="3.0.2" />
<PackageReference Include="HotAvalonia.Extensions" Version="3.0.2" />
```

### 编译符号配置

```xml
<!-- Debug R26 配置 - 启用热重载 -->
<PropertyGroup Condition="'$(Configuration)' == 'Debug R26'">
  <DefineConstants>DEBUG;TRACE</DefineConstants>
</PropertyGroup>

<!-- Release R26 配置 - 禁用热重载 -->
<PropertyGroup Condition="'$(Configuration)' == 'Release R26'">
  <DefineConstants>RELEASE;TRACE</DefineConstants>
</PropertyGroup>
```

### 工作原理

HotAvalonia 3.0.2 **通过 MSBuild 任务自动集成**，无需在代码中显式调用：

```csharp
// Application.cs - 无需额外代码
AppBuilder.Configure<Avalonia.Application>()
    .UsePlatformDetect()
    .LogToTrace()
    .SetupWithoutStarting();  // HotAvalonia 自动注入

// ❌ 不需要调用 .UseHotReload() 或 .EnableHotReload()
```

---

## 使用步骤

### 1. 启动调试模式

#### Visual Studio
1. **选择配置**：在工具栏选择 `Debug R26` 配置
   ```
   [Debug R26 ▼] [Any CPU ▼] [▶ 启动]
   ```

2. **启动调试**：按 `F5` 或点击"启动"按钮
   - VS 会自动启动 Revit 2026
   - Revit 完全加载后，插件自动初始化

3. **打开插件窗口**：
   - 在 Revit 中找到 **RevitAva** 选项卡
   - 点击 **设置** 按钮
   - SettingView 窗口打开

4. **保持窗口打开**：热重载需要窗口实例存在

---

### 2. 修改 XAML

在 Visual Studio 中打开 `RevitAva/Views/SettingView.axaml`：

```xml
<!-- 原始代码 -->
<Grid Margin="20">
    <Button Theme="{DynamicResource OutlineButton}" Classes="Success">
        Warning
    </Button>
</Grid>
```

尝试修改：

```xml
<!-- 修改后 -->
<Grid Margin="20">
    <StackPanel Spacing="10">
        <!-- 修改主题 -->
        <Button Theme="{DynamicResource SolidButton}" Classes="Primary" Width="200">
            主按钮
        </Button>

        <!-- 修改颜色类 -->
        <Button Theme="{DynamicResource OutlineButton}" Classes="Success" Width="200">
            成功
        </Button>

        <!-- 修改样式 -->
        <Button Theme="{DynamicResource BorderlessButton}" Classes="Danger" Width="200">
            危险操作
        </Button>
    </StackPanel>
</Grid>
```

---

### 3. 保存并观察

1. **保存文件**：按 `Ctrl + S`
2. **切换到 Revit 窗口**：查看 SettingView
3. **自动更新**：窗口应在 1-2 秒内自动刷新

---

## 热重载能力范围

### ✅ 支持的修改（通常有效）

#### 1. 控件属性修改
```xml
<!-- 修改前 -->
<Button Width="100" Height="30">Click Me</Button>

<!-- 修改后 - 立即生效 -->
<Button Width="200" Height="50" FontSize="16">点击我</Button>
```

#### 2. 样式类修改
```xml
<!-- 修改前 -->
<Button Classes="Primary">按钮</Button>

<!-- 修改后 - 立即生效 -->
<Button Classes="Danger">按钮</Button>
```

#### 3. 主题切换
```xml
<!-- 修改前 -->
<Button Theme="{DynamicResource OutlineButton}">按钮</Button>

<!-- 修改后 - 立即生效 -->
<Button Theme="{DynamicResource SolidButton}">按钮</Button>
```

#### 4. 布局修改
```xml
<!-- 修改前 -->
<Grid Margin="10">
    <Button>Test</Button>
</Grid>

<!-- 修改后 - 立即生效 -->
<StackPanel Margin="20" Spacing="10">
    <Button>Test 1</Button>
    <Button>Test 2</Button>
</StackPanel>
```

#### 5. 文本内容
```xml
<!-- 修改前 -->
<TextBlock Text="Hello" />

<!-- 修改后 - 立即生效 -->
<TextBlock Text="你好，世界" FontWeight="Bold" />
```

---

### ⚠️ 可能需要重新打开窗口的修改

#### 1. 添加/删除复杂控件
```xml
<!-- 添加新的复杂控件可能需要重新打开窗口 -->
<DataGrid ItemsSource="{Binding Items}" />
```

#### 2. 修改控件结构
```xml
<!-- 从 Grid 改为 DockPanel 可能需要重新打开 -->
<DockPanel>...</DockPanel>
```

#### 3. 修改绑定表达式
```xml
<!-- 修改 Binding 路径可能需要重新打开 -->
<TextBlock Text="{Binding NewPropertyName}" />
```

---

### ❌ 不支持的修改（需要重新编译）

#### 1. ViewModel 代码修改
```csharp
// SettingViewModel.cs - 任何修改都需要重新编译
[ObservableProperty]
private string _newProperty;  // 新增属性需要重新编译
```

#### 2. Code-behind 修改
```csharp
// SettingView.axaml.cs - 任何修改都需要重新编译
public void OnButtonClick()  // 新方法需要重新编译
{
    // ...
}
```

#### 3. 资源字典修改
```xml
<!-- Resources/Styles/CustomStyles.axaml - 需要重新编译 -->
<Style Selector="Button.Custom">
    <Setter Property="Background" Value="Red"/>
</Style>
```

---

## 调试技巧

### 1. 查看热重载日志

#### Visual Studio 输出窗口
1. **打开输出窗口**：`视图` > `输出`（或 `Ctrl+Alt+O`）
2. **选择调试输出**：在"显示输出来源"下拉菜单中选择 **调试**
3. **查找 HotAvalonia 消息**：
   ```
   [HotAvalonia] Watching for changes in: SettingView.axaml
   [HotAvalonia] Change detected: SettingView.axaml
   [HotAvalonia] Hot reload completed successfully
   ```

---

### 2. 使用 Avalonia DevTools

项目已启用 Avalonia Diagnostics（Debug 模式）：

```xml
<PackageReference Include="Avalonia.Diagnostics" Version="11.3.7"
                  Condition="'$(Configuration)' == 'Debug R26'" />
```

#### 使用方法
1. **打开窗口**：在 SettingView 窗口激活状态下按 `F12`
2. **实时调整属性**：
   - 左侧：控件树（可选择任意控件）
   - 右侧：属性面板（可实时修改）
   - 查看样式、数据绑定、渲染信息

3. **配合热重载使用**：
   - 在 DevTools 中试验属性值
   - 确定效果后，修改 XAML 文件
   - 保存 XAML，热重载自动应用

---

### 3. 故障排查

#### 问题：热重载不工作

**检查清单**：

1. **确认配置**：
   ```bash
   # 确保使用 Debug R26 配置
   dotnet build --configuration "Debug R26"
   ```

2. **确认调试状态**：
   - Visual Studio 工具栏显示 **正在调试 - Revit.exe**
   - 或者 VS 已附加到 Revit 进程

3. **检查窗口状态**：
   - SettingView 窗口必须打开
   - 窗口未最小化

4. **检查文件保存**：
   - 确保已保存 XAML 文件（`Ctrl+S`）
   - 文件标题没有 `*` 标记

5. **查看输出**：
   - VS 输出窗口是否有错误信息
   - Revit 控制台是否有异常

**解决方法**：

```bash
# 方法 1：重新打开窗口
# 1. 关闭 SettingView
# 2. 在 Revit 中重新点击"设置"按钮

# 方法 2：重新附加调试器
# 1. 停止调试（Shift+F5）
# 2. 重新启动调试（F5）

# 方法 3：清理并重新构建
dotnet clean
dotnet build --configuration "Debug R26"
```

---

#### 问题：修改后窗口崩溃

**可能原因**：
- 绑定到不存在的属性
- 资源引用错误
- XAML 语法错误

**解决方法**：
1. 查看 VS 输出窗口的错误信息
2. 撤销最后的修改（`Ctrl+Z`）
3. 保存文件，重新打开窗口
4. 逐步添加修改，确定问题代码

---

#### 问题：某些修改不生效

**检查**：
- 是否修改了 ViewModel 代码？→ 需要重新编译
- 是否修改了资源文件？→ 需要重新编译
- 是否修改了复杂绑定？→ 可能需要重新打开窗口

---

## 最佳实践

### 1. 开发工作流

```
1. 启动调试（F5）
   ↓
2. 打开插件窗口
   ↓
3. 打开 DevTools（F12）试验样式
   ↓
4. 修改 XAML 文件
   ↓
5. 保存（Ctrl+S）→ 自动热重载
   ↓
6. 重复步骤 4-5
   ↓
7. 完成后停止调试（Shift+F5）
```

---

### 2. 小步迭代

**推荐**：
```xml
<!-- 步骤 1：修改按钮宽度 -->
<Button Width="200">测试</Button>
<!-- 保存 → 查看效果 ✅ -->

<!-- 步骤 2：添加颜色类 -->
<Button Width="200" Classes="Primary">测试</Button>
<!-- 保存 → 查看效果 ✅ -->

<!-- 步骤 3：修改主题 -->
<Button Width="200" Classes="Primary" Theme="{DynamicResource SolidButton}">测试</Button>
<!-- 保存 → 查看效果 ✅ -->
```

**不推荐**：
```xml
<!-- 一次性修改太多内容 -->
<Grid>
    <StackPanel>
        <Button Classes="Primary" Theme="{DynamicResource SolidButton}">按钮1</Button>
        <Button Classes="Success" Theme="{DynamicResource OutlineButton}">按钮2</Button>
        <DataGrid ItemsSource="{Binding Items}" />
        <TextBox Text="{Binding Name, Mode=TwoWay}" />
    </StackPanel>
</Grid>
<!-- 如果不生效，难以定位问题 ❌ -->
```

---

### 3. 使用版本控制

在大量修改前，提交当前工作：

```bash
# 保存当前稳定状态
git add .
git commit -m "feat: 完成基础 UI 布局"

# 现在可以放心实验
# 如果实验失败，可以轻松回退
git restore .
```

---

### 4. 性能优化

**热重载对性能的影响**：
- Debug 模式下，HotAvalonia 会监视文件变化
- 轻微的内存和 CPU 开销
- **仅影响开发环境**，Release 模式下完全禁用

**如果感觉卡顿**：
1. 关闭不需要的窗口
2. 减少同时打开的 XAML 文件数量
3. 使用 Release 配置进行性能测试

---

## 常见问题

### Q1: Release 模式下热重载会工作吗？
**A:** 不会。HotAvalonia 仅在 `DEBUG` 符号定义时启用，Release 模式下完全移除相关代码。

---

### Q2: 热重载会影响生产环境性能吗？
**A:** 不会。Release 构建中不包含 HotAvalonia 代码，没有任何性能影响。

---

### Q3: 可以在不附加调试器的情况下使用热重载吗？
**A:** HotAvalonia 3.0.2 理论上支持，但在 Revit 插件环境下建议始终附加调试器，以便查看日志和错误。

---

### Q4: 如何禁用热重载？
**A:**
```xml
<!-- 临时禁用：切换到 Release R26 配置 -->

<!-- 永久移除：删除包引用 -->
<!-- <PackageReference Include="HotAvalonia" Version="3.0.2" /> -->
<!-- <PackageReference Include="HotAvalonia.Extensions" Version="3.0.2" /> -->
```

---

### Q5: 热重载支持哪些文件类型？
**A:** 主要支持 `.axaml` 文件。`.cs` 文件修改需要重新编译。

---

## 参考资料

- [HotAvalonia GitHub](https://github.com/Kir-Antipov/HotAvalonia)
- [HotAvalonia NuGet](https://www.nuget.org/packages/HotAvalonia/)
- [Avalonia DevTools 文档](https://docs.avaloniaui.net/docs/guides/developer-tools/devtools)
- [Semi.Avalonia 官方文档](https://docs.irihi.tech/semi/)

---

## 总结

✅ **已配置 HotAvalonia 3.0.2**
✅ **支持 Debug R26 模式下的 XAML 热重载**
✅ **自动集成，无需代码修改**
✅ **Release 模式下自动禁用，无性能影响**

**开发效率提升**：
- ⏱️ 修改 UI 无需重启 Revit（节省 ~30秒/次）
- 🎯 实时查看效果，快速迭代
- 🛠️ 配合 DevTools，精确调整样式
